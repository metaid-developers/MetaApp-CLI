# 可视化流程图

## 🎨 完整登录注册流程（参考 IDChat）

```
┌─────────────────────────────────────────────────────────────┐
│                     用户访问页面                             │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              页面初始化（App.vue onMounted）                 │
│  ┌────────────────────────────────────────────────────┐    │
│  │  1. userStore.init()                               │    │
│  │     └─→ 从 localStorage 加载用户信息               │    │
│  │                                                     │    │
│  │  2. walletStore.init()                             │    │
│  │     ├─→ 异步检测 Metalet（300ms × 50 = 15秒）      │    │
│  │     ├─→ 检测到 → 尝试获取当前地址                  │    │
│  │     └─→ 地址匹配 → 恢复登录状态                    │    │
│  │                                                     │    │
│  │  3. walletStore.setupEventListeners()             │    │
│  │     ├─→ 监听账户切换                               │    │
│  │     └─→ 监听网络切换                               │    │
│  └────────────────────────────────────────────────────┘    │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                 页面渲染完成                                 │
│                                                              │
│  ┌──────────────┐     ┌──────────────┐                     │
│  │ 未检测到钱包  │     │ 检测到钱包    │                     │
│  │ (15秒超时)   │     │ (成功检测)    │                     │
│  └──────┬───────┘     └──────┬───────┘                     │
│         │                    │                              │
│         ▼                    ▼                              │
│  ┌──────────────┐     ┌──────────────┐                     │
│  │ 显示         │     │ localStorage │                     │
│  │ "安装Metalet"│     │ 有用户信息？  │                     │
│  └──────────────┘     └──────┬───────┘                     │
│                              │                              │
│         ┌────────────────────┼────────────────────┐        │
│         │                    │                    │        │
│         ▼                    ▼                    ▼        │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐│
│  │   是 且       │     │   是 但       │     │     否       ││
│  │  地址匹配     │     │  地址不匹配    │     │  (新访问)   ││
│  └──────┬───────┘     └──────┬───────┘     └──────┬───────┘│
│         │                    │                    │        │
│         ▼                    ▼                    ▼        │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐│
│  │ ✅ 自动恢复   │     │ ⚠️ 清空旧     │     │   显示       ││
│  │   登录状态    │     │   用户信息    │     │"Connect      ││
│  │              │     │ 显示连接按钮   │     │  Wallet"    ││
│  └──────────────┘     └──────────────┘     └──────┬───────┘│
│                                                    │        │
└────────────────────────────────────────────────────┼────────┘
                                                     │
        ┌────────────────────────────────────────────┘
        │
        │ 用户点击 "Connect Wallet"
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                 ConnectWalletModal 弹窗                      │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │  步骤 1: 选择钱包                                   │    │
│  │  ────────────────────────────────────             │    │
│  │  □ 勾选《用户协议》和《隐私政策》                  │    │
│  │  [Metalet 钱包] 按钮                               │    │
│  └────────────────────┬───────────────────────────────┘    │
│                       │                                     │
│                       │ 用户勾选协议并点击                   │
│                       │                                     │
│                       ▼                                     │
│  ┌────────────────────────────────────────────────────┐    │
│  │  步骤 2: 检测钱包（detecting）                     │    │
│  │  ────────────────────────────────────             │    │
│  │  🔄 "正在检测 Metalet 钱包..."                     │    │
│  │                                                     │    │
│  │  services/walletConnect.ts:                        │    │
│  │  ├─→ walletStore.waitForMetalet(20, 300)          │    │
│  │  └─→ 每 300ms 检查一次，最多 20 次 = 6秒          │    │
│  └────────────────────┬───────────────────────────────┘    │
│                       │                                     │
│         ┌─────────────┴─────────────┐                      │
│         │                           │                      │
│         ▼                           ▼                      │
│  ┌──────────────┐           ┌──────────────┐              │
│  │ 未检测到      │           │  检测成功     │              │
│  │ (6秒超时)    │           │              │              │
│  └──────┬───────┘           └──────┬───────┘              │
│         │                          │                       │
│         ▼                          ▼                       │
│  ┌──────────────┐           ┌──────────────────────────┐  │
│  │ 错误提示:     │           │  步骤 3: 连接钱包         │  │
│  │ "未检测到钱包"│           │  (connecting)            │  │
│  │              │           │  ──────────────────      │  │
│  │ 打开安装链接  │           │  🔗 "请在Metalet中确认"  │  │
│  └──────────────┘           │                          │  │
│                             │  walletStore.connect()    │  │
│                             │  └─→ metaidwallet.connect()│  │
│                             └──────┬───────────────────┘  │
│                                    │                       │
│                      ┌─────────────┴─────────────┐        │
│                      │                           │        │
│                      ▼                           ▼        │
│               ┌──────────────┐           ┌──────────────┐ │
│               │ 用户拒绝      │           │  连接成功     │ │
│               │ (取消连接)    │           │              │ │
│               └──────┬───────┘           └──────┬───────┘ │
│                      │                          │         │
│                      ▼                          ▼         │
│               ┌──────────────┐           ┌──────────────────────────┐│
│               │ 错误提示:     │           │  步骤 4: 检查用户类型     ││
│               │ "连接被拒绝"  │           │  (checking)              ││
│               └──────────────┘           │  ──────────────────      ││
│                                          │  🔍 "正在检查用户信息"   ││
│                                          │                          ││
│                                          │  api.checkUserExists()    ││
│                                          └──────┬───────────────────┘│
│                                                 │                     │
│                                   ┌─────────────┴─────────────┐      │
│                                   │                           │      │
│                                   ▼                           ▼      │
│                            ┌──────────────┐           ┌──────────────┐
│                            │   新用户      │           │   老用户      │
│                            │  (isNew=true) │           │ (isNew=false)│
│                            └──────┬───────┘           └──────┬───────┘
│                                   │                          │       │
│                                   ▼                          ▼       │
│  ┌────────────────────────────────────────┐  ┌────────────────────────────────────┐│
│  │  步骤 5A: 注册流程 (registering)        │  │  步骤 5B: 登录流程 (logging-in)    ││
│  │  ──────────────────────────────        │  │  ──────────────────────────        ││
│  │  📝 "正在为您创建账户..."              │  │  🔐 "正在登录..."                  ││
│  │                                         │  │                                    ││
│  │  api.registerUser(account, profile)    │  │  api.loginUser(account, signature) ││
│  │  ├─→ 创建 UserInfo                     │  │  ├─→ 验证签名（可选）              ││
│  │  ├─→ 生成 Access Token                 │  │  ├─→ 获取 UserInfo                 ││
│  │  └─→ 返回 { user, token }              │  │  └─→ 返回 { user, token }          ││
│  └────────────────────┬───────────────────┘  └────────────────┬───────────────────┘│
│                       │                                        │                    │
│                       └────────────────┬───────────────────────┘                    │
│                                        │                                            │
│                                        ▼                                            │
│  ┌────────────────────────────────────────────────────────────────────────────┐   │
│  │  步骤 6: 保存用户信息                                                       │   │
│  │  ──────────────────────────────                                            │   │
│  │  userStore.userInfo = result.data.user                                     │   │
│  │  userStore.accessToken = result.data.token                                 │   │
│  │  userStore.saveToStorage()                                                 │   │
│  │      │                                                                      │   │
│  │      ├─→ localStorage.setItem('metaid_user_info', JSON.stringify(user))   │   │
│  │      ├─→ localStorage.setItem('metaid_access_token', token)               │   │
│  │      └─→ localStorage.setItem('metaid_wallet_address', address)           │   │
│  └────────────────────┬───────────────────────────────────────────────────────┘   │
│                       │                                                            │
│                       ▼                                                            │
│  ┌────────────────────────────────────────────────────────────────────────────┐   │
│  │  步骤 7: 成功 (success)                                                     │   │
│  │  ──────────────────────────────                                            │   │
│  │  ✅ "登录成功！"                                                            │   │
│  │                                                                             │   │
│  │  callbacks.onSuccess(account, isNewUser)                                   │   │
│  │  ├─→ UI 显示成功图标                                                        │   │
│  │  ├─→ 显示用户地址                                                           │   │
│  │  └─→ 1.5秒后自动关闭弹窗                                                   │   │
│  └────────────────────┬───────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                  返回主页面                                  │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │  UI 自动更新：                                      │    │
│  │  ├─→ 右上角显示用户信息卡片                         │    │
│  │  ├─→ 登录状态卡片显示"✅ 已登录"                    │    │
│  │  ├─→ 用户信息卡片显示头像、名称、地址               │    │
│  │  └─→ 下拉菜单可断开连接                             │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 🔄 账户切换流程

```
用户在 Metalet 中切换账户
    ↓
触发 accountsChanged 事件
    ↓
walletStore.setupEventListeners() 中的监听器
    ↓
┌─────────────────────────────────────┐
│  检测到新账户                        │
│  newAccount.address !== 旧地址      │
└─────────────────┬───────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│  清空旧用户信息                      │
│  userStore.logout()                 │
│  ├─→ userInfo = null                │
│  ├─→ accessToken = null             │
│  └─→ 清空 localStorage               │
└─────────────────┬───────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│  UI 更新                             │
│  ├─→ 显示 "Connect Wallet" 按钮     │
│  └─→ 提示用户重新登录                │
└─────────────────────────────────────┘
```

## 🚪 退出登录流程

```
用户点击 "断开连接"
    ↓
walletStore.disconnect()
    │
    ├─→ 调用 metaidwallet.disconnect()
    │
    └─→ 调用 userStore.logout()
        │
        ├─→ 清空状态
        │   ├─ userInfo = null
        │   ├─ accessToken = null
        │   └─ loginError = null
        │
        └─→ 清空 localStorage
            ├─ removeItem('metaid_user_info')
            ├─ removeItem('metaid_access_token')
            └─ removeItem('metaid_wallet_address')
    ↓
UI 自动更新
    ├─→ 右上角显示 "Connect Wallet" 按钮
    ├─→ 登录状态卡片显示 "❌ 未登录"
    └─→ 用户信息卡片隐藏
```

## 📦 数据流向图

```
┌─────────────────────────────────────────────────────────────┐
│                  浏览器层                                     │
│                                                              │
│  ┌──────────────┐          ┌──────────────┐                │
│  │   Metalet    │          │  localStorage│                │
│  │   Extension  │          │              │                │
│  └──────┬───────┘          └──────┬───────┘                │
│         │                         │                         │
└─────────┼─────────────────────────┼─────────────────────────┘
          │                         │
          │ window.metaidwallet     │ get/set/remove
          │                         │
┌─────────┼─────────────────────────┼─────────────────────────┐
│         │         应用层           │                         │
│         │                         │                         │
│         ▼                         ▼                         │
│  ┌──────────────┐          ┌──────────────┐                │
│  │  Wallet      │          │    User      │                │
│  │  Store       │◄─────────┤    Store     │                │
│  └──────┬───────┘          └──────┬───────┘                │
│         │                         │                         │
│         │  使用                    │  使用                   │
│         │                         │                         │
│         ▼                         ▼                         │
│  ┌──────────────────────────────────────┐                  │
│  │   walletConnect Service              │                  │
│  │   (核心业务逻辑)                     │                  │
│  └──────┬───────────────────────────────┘                  │
│         │                                                   │
│         │  调用                                             │
│         │                                                   │
│         ▼                                                   │
│  ┌──────────────────────────────────────┐                  │
│  │      User API Layer                  │                  │
│  │  ├─ checkUserExists()                │                  │
│  │  ├─ loginUser()                      │                  │
│  │  └─ registerUser()                   │                  │
│  └──────┬───────────────────────────────┘                  │
│         │                                                   │
└─────────┼───────────────────────────────────────────────────┘
          │
          │ HTTP Request
          │
┌─────────▼───────────────────────────────────────────────────┐
│                  后端服务器                                   │
│                                                              │
│  ┌──────────────┐          ┌──────────────┐                │
│  │  用户数据库   │          │  Token 服务   │                │
│  └──────────────┘          └──────────────┘                │
└─────────────────────────────────────────────────────────────┘
```

## 🎯 核心方法调用链

### connectMetalet() 调用链

```
ConnectWalletModal.vue
    │
    │ const result = await connectMetalet({ callbacks })
    │
    ▼
services/walletConnect.ts :: connectMetalet()
    │
    ├──→ [1] walletStore.waitForMetalet(20, 300)
    │       └─→ 每 300ms 检查 window.metaidwallet
    │           └─→ 返回 boolean
    │
    ├──→ [2] walletStore.connect()
    │       └─→ window.metaidwallet.connect()
    │           └─→ 返回 MetaletAccount
    │
    ├──→ [3] api.checkUserExists(address)
    │       └─→ fetch('/api/users/check?address=...')
    │           └─→ 返回 { exists, isNewUser }
    │
    ├──→ [4A] api.registerUser(account, profile)  (新用户)
    │       └─→ fetch('/api/users/register', ...)
    │           └─→ 返回 { user, token }
    │
    ├──→ [4B] api.loginUser(account, signature)   (老用户)
    │       └─→ fetch('/api/users/login', ...)
    │           └─→ 返回 { user, token }
    │
    └──→ [5] userStore.saveToStorage()
            └─→ utils/storage.setStorage()
                ├─→ localStorage.setItem('metaid_user_info', ...)
                ├─→ localStorage.setItem('metaid_access_token', ...)
                └─→ localStorage.setItem('metaid_wallet_address', ...)
    │
    └──→ callbacks.onSuccess(account, isNewUser)
```

## 🔍 状态变化时序图

```
时间轴                          loginStep 状态              UI 显示
─────────────────────────────────────────────────────────────────────────
0ms      用户点击连接           'select'               钱包选择界面
                                                        
100ms    点击 Metalet           'detecting'            🔄 检测动画
                                                       "正在检测钱包..."
                                                        
2000ms   检测成功               'connecting'           🔗 连接动画
                                                       "请在Metalet中确认"
                                                        
5000ms   用户确认连接           'checking'             🔍 加载动画
                                                       "正在检查用户信息..."
                                                        
6000ms   检查完成(新用户)       'registering'          📝 加载动画
                                                       "正在创建账户..."
                                                        
或       检查完成(老用户)       'logging-in'           🔐 加载动画
                                                       "正在登录..."
                                                        
7000ms   注册/登录成功          'success'              ✅ 成功图标
                                                       "登录成功！"
                                                       显示地址
                                                        
8500ms   自动关闭弹窗           (关闭)                 返回主页面
                                                       显示用户信息
```

## 💾 LocalStorage 变化图

```
初始状态（未登录）
┌──────────────────────────┐
│  localStorage            │
│  (空)                    │
└──────────────────────────┘

            │
            │ 登录成功
            ▼

登录后
┌──────────────────────────────────────────────────────┐
│  localStorage                                         │
│  ┌────────────────────────────────────────────────┐ │
│  │ metaid_user_info: {                            │ │
│  │   address: "1ABC...",                          │ │
│  │   mvcAddress: "xxx...",                        │ │
│  │   btcAddress: "bc1...",                        │ │
│  │   name: "用户1ABC",                            │ │
│  │   loginTime: 1696934400000,                    │ │
│  │   lastActiveTime: 1696934400000                │ │
│  │ }                                              │ │
│  ├────────────────────────────────────────────────┤ │
│  │ metaid_access_token: "token_1ABC..._16969..."  │ │
│  ├────────────────────────────────────────────────┤ │
│  │ metaid_wallet_address: "1ABC..."               │ │
│  └────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────┘

            │
            │ 退出登录
            ▼

退出后
┌──────────────────────────┐
│  localStorage            │
│  (已清空)                │
│  ❌ metaid_user_info      │
│  ❌ metaid_access_token   │
│  ❌ metaid_wallet_address │
└──────────────────────────┘
```

## 🔄 刷新页面恢复流程

```
页面刷新
    ↓
App.vue: onMounted()
    ↓
┌─────────────────────────────────────────────┐
│  1. userStore.init()                        │
│     └─→ loadFromStorage()                   │
│         └─→ localStorage.getItem(...)       │
│             ├─→ 找到数据 → 恢复状态          │
│             └─→ 未找到 → 保持未登录          │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  2. walletStore.init()                      │
│     ├─→ waitForMetalet() (15秒)            │
│     ├─→ getAddress() 获取当前钱包地址       │
│     └─→ 验证地址                            │
│         ├─→ 匹配 → updateLastActiveTime()   │
│         └─→ 不匹配 → userStore.logout()     │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  3. walletStore.setupEventListeners()      │
│     ├─→ on('accountsChanged')              │
│     └─→ on('networkChanged')               │
└─────────────────┬───────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────┐
│  页面渲染完成                                │
│  ├─→ 登录状态已恢复（如果地址匹配）          │
│  └─→ 或显示"Connect Wallet"（如果未登录）   │
└─────────────────────────────────────────────┘
```

## 📚 模块依赖图

```
ConnectWalletModal.vue
    │
    ├─→ connectMetalet() from '@/services/walletConnect'
    ├─→ useWalletStore() from '@/stores/wallet'
    └─→ useUserStore() from '@/stores/user'

services/walletConnect.ts
    │
    ├─→ useWalletStore()
    │   ├─→ waitForMetalet()
    │   └─→ connect()
    │
    ├─→ useUserStore()
    │   └─→ saveToStorage()
    │       └─→ utils/storage.setStorage()
    │
    └─→ api/user
        ├─→ checkUserExists()
        ├─→ loginUser()
        └─→ registerUser()
            └─→ fetch() (浏览器 API)

stores/wallet.ts
    │
    └─→ window.metaidwallet (Metalet Wallet API)

stores/user.ts
    │
    └─→ utils/storage
        ├─→ getStorage()
        ├─→ setStorage()
        └─→ clearStorage()
```

## 🎨 UI 状态机

```
         ┌──────────┐
         │  select  │ ◄─── 初始状态
         └─────┬────┘
               │ 点击连接
               ▼
         ┌──────────┐
         │detecting │ ◄─── 检测钱包
         └─────┬────┘
               │ 检测成功
               ▼
         ┌──────────┐
         │connecting│ ◄─── 连接钱包
         └─────┬────┘
               │ 连接成功
               ▼
         ┌──────────┐
         │ checking │ ◄─── 检查用户
         └─────┬────┘
               │
      ┌────────┴────────┐
      │                 │
      ▼                 ▼
┌────────────┐    ┌────────────┐
│registering │    │ logging-in │
│  (新用户)  │    │  (老用户)  │
└─────┬──────┘    └─────┬──────┘
      │                 │
      └────────┬────────┘
               │ 成功
               ▼
         ┌──────────┐
         │ success  │ ◄─── 成功状态
         └─────┬────┘
               │ 1.5秒后
               ▼
           (关闭弹窗)
               │
               ▼
           (结束)
```

## 🔐 安全流程图

```
用户连接钱包
    ↓
┌─────────────────────────────────────┐
│  1. 用户协议保护                     │
│     if (!isAgreementAccepted) {     │
│       return '请先同意协议'          │
│     }                                │
└─────────────────┬───────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│  2. 钱包连接（用户必须确认）          │
│     window.metaidwallet.connect()   │
│     └─→ 用户在 Metalet 中确认        │
└─────────────────┬───────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│  3. 可选：签名验证                   │
│     signLoginMessage(address)       │
│     └─→ 证明地址所有权               │
└─────────────────┬───────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│  4. 服务器验证（TODO）               │
│     api.loginUser(account, signature)│
│     └─→ 后端验证签名                 │
└─────────────────┬───────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│  5. 返回 Token                       │
│     { user, token }                 │
│     └─→ 保存到 localStorage          │
└─────────────────┬───────────────────┘
                  │
                  ▼
┌─────────────────────────────────────┐
│  6. 定期检查 Token 有效性            │
│     checkLoginStatus()              │
│     └─→ 7天未活跃自动退出            │
└─────────────────────────────────────┘
```

## 📝 关键代码片段

### 1. 核心连接方法

```typescript
// services/walletConnect.ts
export async function connectMetalet(callbacks) {
  // 步骤 1: 检测
  callbacks?.onStepChange?.('detecting')
  const isAvailable = await walletStore.waitForMetalet(20, 300)
  
  // 步骤 2: 连接
  callbacks?.onStepChange?.('connecting')
  await walletStore.connect()
  
  // 步骤 3: 检查
  callbacks?.onStepChange?.('checking')
  const { isNewUser } = await checkUserExists(address)
  
  // 步骤 4: 注册/登录
  if (isNewUser) {
    callbacks?.onStepChange?.('registering')
    await registerUser(account)
  } else {
    callbacks?.onStepChange?.('logging-in')
    await loginUser(account)
  }
  
  // 步骤 5: 完成
  userStore.saveToStorage()
  callbacks?.onSuccess?.(account, isNewUser)
  
  return { success: true, isNewUser }
}
```

### 2. 组件使用

```vue
<!-- ConnectWalletModal.vue -->
<script setup>
const connectMetalet = async () => {
  const result = await connectMetaletService({
    onStepChange: (step) => loginStep.value = step,
    onProgress: (msg) => progressMessage.value = msg,
    onError: (err) => errorMessage.value = err,
    onSuccess: (account, isNew) => {
      emit('success', isNew)
      setTimeout(closeModal, 1500)
    },
  })
}
</script>
```

---

**完整的企业级 Web3 登录注册系统 v2.0 已就绪！** 🎉

**立即开始：** `./dev.sh` → 访问 http://localhost:5174 → 点击 "Connect Wallet" 🚀

